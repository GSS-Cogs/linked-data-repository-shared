
# Messenger Clients

**All** messenger clients are expected to conform to the `BaseMessenger` class as defined in `base.py` and to return python objects conforming to the `BaseMessenger` class  (also from `base.py`). 


## GCP PubSub Client: Usage

```python
import json
from typing import Union

from ldrshared.clients import PubSubClient, BaseMessage

client = PubSubClient()

# -----
# Subscribe and get messages

client.subscribe('my-topic')
while True:
    # note: default timeout is 10 seconds, that's probably fine
    message: Union[BaseMessage, None] = client.get_next_message(timeout=30)
    if message:
        message_as_dict: dict = message.get()
        field_from_message: Union[str, dict] = message.get('content')
        # do something with it

# -----
# Put a message
client.put_one_message('my-topic', 'I r a message')
# or
client.put_one_message('my-topic', {'i am': 'a more complex message'})
```

NOTE: You'll also need to:

* Set an environemtn variable of `GCP_PROJECT_ID` setting your project ID.
* Have credentials, either via service account (for production) or via the `gcloud` cli for development (see the following section on running pubusb tests for details).


## Message Structure

Our pubsub messages follow the following structure

```json
{
    "time_stamp": "<INSTANT OF PUBLICAITON PUT - GENERATED BY THE CLIENT NOT YOU>",
    "content": "<THE 'MESSAGE' THAT WAS PASSED IN>"
}
```

So where (in out earlier example) we did `message.get('content')` that was retrieving the exact string that was originally passed in.



## GCP PubSub Client: Running Tests

At time of writing the tests PubSub client tests are running against topics and subscriptions on GCP itself so we're **not** running them on commit, a developer needs to explicitly call them.

These tests **will** clean up after themselves regardless of test results (provided you don't bomb out early - please don't do that).

To run these tests:

* Install the gcp cli https://cloud.google.com/sdk/docs/install
* Authenticate your machine with `gcloud auth login` and your **gsscogs.uk** address
* use `gcloud auth application-default login` and your **gsscogs.uk** address - this will tell gcloud to use your developer credentials for applications locally (in place of holdings lots of different service account credentials on your machine).
* `chmod +x ./tests.sh`
* From then on you can run the gcp tests via `./tests.sh` 
